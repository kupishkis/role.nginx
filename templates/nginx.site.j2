# {{ansible_managed}}

server {
  listen   {{item.port}};
  {% if item.subpath is defined %}
  server_name  {{item.subpath}}.{{item.name}}.{{hostname}};
  {% else %}
  server_name  {{item.name}}.{{hostname}}
  {% endif %}

  access_log  {{nginx_log_dir}}/access.log;

  index index.php;

  {% if item.subpath is defined %}
  root   {{item.path}}/{{item.subpath}}/public;
  {% else %}
  root   {{item.path}}/public
  {% endif %}

  location / {
    try_files $uri /index.php?$args;
  }

  location ~ \.php$ {
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass unix:{{php_fpm_var_dir}}/{{item.name}}.sock;
  	fastcgi_index index.php;
  	include fastcgi_params;
  }
}
